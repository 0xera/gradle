/**
 * Tests tasks to allow the gradual introduction of JDK 9 support
 */
String jdkVarName = 'JAVA_9'

task java9IntegTest(type: Test) {
    excludes = [
        // Broken api jar construction due to ASM not working with Java 9 bytecode
        "MixedLegacyAndComponentJvmPluginIntegrationTest",
        "JavaCompilationAgainstApiJarIntegrationTest",
        "JavaLanguageIntegrationTest",
        "SampleJavaLanguageIntegrationTest",
        "CustomComponentJarBinariesIntegrationTest",
        "JarBinaryTypeVariantsTest",
        "JavaJvmAssemblyIntegrationTest",
        "JavaLanguageCustomLibraryDependencyResolutionIntegrationTest",
        "JavaLanguageDependencyResolutionIntegrationTest",
        "JavaLanguageIncrementalBuildIntegrationTest",
        "MixedNativeAndJvmProjectIntegrationTest",
        "JavaCompilationAgainstDependenciesIntegrationTest",

        // Cannot obtain Jvm arguments via java.lang.management.ManagementFactory.runtimeMXBean.inputArguments module java.management does not export sun.management to unnamed module @6427ecb
        "BuildEnvironmentModelCrossVersionSpec",  // "informs about java args as in the build script"
        "JavaConfigurabilityCrossVersionSpec", // "customized java args are reflected in the inputArguments and the build model", "tooling api provided jvm args take precedence over gradle.properties"
        "GradlePropertiesToolingApiCrossVersionSpec", // "tooling api honours jvm args specified in gradle.properties"

        // Old Gradle cannot run against Java 9
        "org/gradle/integtests/tooling/r22/BuildActionCrossVersionSpec", // current -> 2.13
        "org/gradle/integtests/tooling/r25/BuildProgressCrossVersionSpec",
        "org/gradle/integtests/tooling/r25/ContinuousBuildCancellationCrossVersionSpec", // current -> 2.13
        "org/gradle/integtests/tooling/r25/ContinuousBuildCrossVersionSpec", // current -> 2.13
        "org/gradle/integtests/tooling/r25/ContinuousBuildProgressEventsCrossVersionSpec", // current -> 2.13
        "org/gradle/integtests/tooling/r25/DeploymentHandleContinuousBuildCrossVersionSpec", // current -> 2.13
        "org/gradle/integtests/tooling/r25/ProgressCrossVersionSpec", // current -> 2.13
        "org/gradle/integtests/tooling/r25/TaskProgressCrossVersionSpec", // current -> 2.13
        "org/gradle/integtests/tooling/r25/TestProgressCrossVersionSpec", // current -> 2.13
        "org/gradle/integtests/tooling/r25/TestProgressDaemonErrorsCrossVersionSpec", // current -> 2.13
        "org/gradle/integtests/tooling/r26/TestLauncherCrossVersionSpec", // current -> 2.13
        "org/gradle/integtests/tooling/r27/TestLauncherCrossVersionSpec", // current -> 2.13
        "JavaProjectCrossVersionIntegrationTest", // previous = 2.13 or older
        "TaskSubclassingBinaryCompatibilityCrossVersionSpec", // previous = 2.13 or older
        "TaskUpToDateCrossVersionIntegrationTest", // previous = 2.13 or older

        // Compile against Java 9 in older Gradle version
        // class org.gradle.internal.reflect.DirectInstantiator cannot access class com.sun.tools.javac.api.JavacTool (in module jdk.compiler) because module jdk.compiler does not export com.sun.tools.javac.api to unnamed module @4030a92
        "TestFilteringCrossVersionSpec", // current -> 2.13

        // Broken scala and twirl compilation, broken api jar construction
        "MixedPlayAndJvmLibraryProjectIntegrationTest",
        "PlayAppWithFailingTestsIntegrationTest",
        "PlayMultiProjectApplicationIntegrationTest",
        "PlayPlatformIntegrationTest",
        "PlayBinaryAdvancedAppIntegrationTest",
        "PlayDistributionAdvancedAppIntegrationTest",
        "PlayBinaryBasicAppIntegrationTest",
        "PlayDistributionBasicAppIntegrationTest",
        "PlayTestBasicAppIntegrationTest",
        "PlayContinuousBuildIntegrationTest",
        "PlayMultiProjectContinuousBuildIntegrationTest",
        "PlayMultiProjectReloadIntegrationTest",
        "PlayReloadIntegrationTest",
        "PlayTwirlCompilerContinuousIntegrationTest",
        "PlayBinaryAppWithDependenciesIntegrationTest",
        "PlayDistributionAppWithDependenciesIntegrationTest",
        "PlayTestAppWithDependenciesIntegrationTest",
        "AdvancedPlaySampleIntegrationTest",
        "BasicPlaySampleIntegrationTest",
        "MultiprojectPlaySampleIntegrationTest",
        "UserGuidePlaySamplesIntegrationTest",
        "PlayApplicationPluginIntegrationTest",
        "Play23RoutesCompileIntegrationTest",
        "Play24RoutesCompileIntegrationTest",
        "PlayAssetsJarIntegrationTest",
        "PlayRunIntegrationTest",
        "TwirlCompileIntegrationTest",
        "TwirlVersionIntegrationTest",
        "PlayIdeaPluginAdvancedIntegrationTest",
        "PlayIdeaPluginBasicIntegrationTest",
        "PlayIdeaPluginMultiprojectIntegrationTest",
        "ProjectLayoutIntegrationTest",
        "SamplesMixedJavaAndScalaIntegrationTest",
        "SamplesScalaCustomizedLayoutIntegrationTest",
        "SamplesScalaQuickstartIntegrationTest",
        "JointScalaLangIntegrationTest",
        "SampleScalaLanguageIntegrationTest",
        "ScalaCompileParallelIntegrationTest",
        "ScalaCompilerContinuousIntegrationTest",
        "ScalaLanguageIncrementalBuildIntegrationTest",
        "ScalaLanguageIntegrationTest",
        "ScalaCrossCompilationIntegrationTest",
        "IncrementalScalaCompileIntegrationTest",
        "ZincScalaCompilerIntegrationTest",
        "ScalaTestIntegrationTest",
        "ScalaLibraryInitIntegrationTest",
        "ZincScalaCompilerMultiVersionIntegrationTest",

        // Sample attempts to set max perm space
        "SamplesScalaZincIntegrationTest",

        // Cannot build Gradle with Java 9, compiler bug
        "SrcDistributionIntegrationSpec",

        // Test compiles for Java 5
        "ToolingApiUnsupportedClientJvmCrossVersionSpec",
        "MavenConversionIntegrationTest",
        "IncrementalJavaCompileIntegrationTest",
        "SampleTestNGIntegrationTest",
        "TestNGIntegrationTest",

        // Jetty version does not work on Java 9
        "JettyIntegrationSpec",
        "SamplesWebQuickstartIntegrationTest",

        // Missing class javax/xml/bind/DatatypeConverter on PUT to S3
        "S3ClientIntegrationTest",
        "IvyPublishS3IntegrationTest",
        "IvyS3UploadArchivesIntegrationTest",
        "MavenPublishS3IntegrationTest",

        // Test detection fails as ASM does not understand Java 9 bytecode
        "JUnitComponentUnderTestIntegrationTest",
        "JUnitIncrementalTestExecutionTest",
        "JUnitStandaloneTestExecutionIntegrationTest",

        // Test assumes there is a tools.jar
        "IvyPublishHttpIntegTest",
        "IvyHttpPublishIntegrationTest",

        // Codenarc does not work on Java 9
        "IsolatedAntBuilderMemoryLeakIntegrationTest",

        // Attempts to run Gradle 2.8 on Java 9
        "HeterogeneousCompositeBuildCrossVersionSpec",

        // Affected by hack in JavaPluginConvention to force source and target compatibility to Java 8
        "ToolingApiEclipseModelCrossVersionSpec",
        "CommandLineJavaCompilerIntegrationTest",
        "InProcessGroovyCompilerIntegrationTest",
        "InvokeDynamicGroovyCompilerSpec",
        "DaemonGroovyCompilerIntegrationTest",
        "InProcessJavaCompilerIntegrationTest",
        "DaemonJavaCompilerIntegrationTest",
        "EclipseClasspathIntegrationTest",
        "EclipseIntegrationTest",
        "IdeaJavaLanguageSettingsIntegrationTest",

        // Various problems, eg scala compile
        "UserGuideSamplesIntegrationTest",

        // ??
        "ApplicationPluginIntegrationTest",
        "SamplesJavaMultiProjectIntegrationTest",
        "JavaCompileIntegrationTest",
        "BuildDashboardPluginIntegrationTest",
        "JavaLanguageExternalDependencyResolutionIntegrationTest",
        "JavadocIntegrationTest",
        "JUnitConsoleLoggingIntegrationTest",
        "JUnitIntegrationTest",
        "TestNGConsoleLoggingIntegrationTest",
        "JacocoPluginIntegrationTest",
        "EnvJsPluginIntegrationTest",
        "GradleRunnerSamplesEndUserIntegrationTest",
        "MultiRequestWorkerProcessIntegrationTest",
        "SingleRequestWorkerProcessIntegrationTest",
        "WorkerProcessIntegrationTest",
        "PathLimitationIntegrationTest",
        "DirectoryScanningIntegTest",
        "DeprecationHandlingIntegrationTest",
        "BuildSourceBuilderIntegrationTest",
        "ClientShutdownCrossVersionSpec",
        "CompositeBuildDependencyArtifactsCrossVersionSpec",
        "CompositeBuildDependencyGraphCrossVersionSpec",
    ].collect { "**/*${it}*" }
}

task java9Test(type: Test) {
    excludes = [

        // Classes used by junit execution tests
        "ABrokenJunit3TestClass",
        "ABrokenTestClass",
        "ATestClassWhichCannotBeLoaded",
        "ATestClassWithBrokenBeforeAndAfterMethod",
        "ATestClassWithBrokenBeforeClassMethod",
        "ATestClassWithBrokenBeforeMethod",
        "ATestClassWithBrokenConstructor",
        "ATestClassWithRunner",
        "ATestClassWithBrokenRunner",
        "ATestClassWithRunnerThatBreaksAfterRunningSomeTests",
        "ATestClassWithSeveralMethods",
        "ATestClassWithUnconstructibleRunner",

        // Needs to be reworked to test pre java 9 and java 9 layouts
        "JvmTest",

        // ??
        "FilteringClassLoaderTest",
        "DefaultJavaToolChainTest",
        "JdkToolsTest",
        "JdkToolsTest",
        "PayloadSerializerTest",
        "GeneratedArchiveBuildOutcomeComparatorTest",
        "ArchiveEntryTest",
        "GroovyStackTraceSpecTest",
        "DefaultFileOperationsTest"
    ].collect { "**/*${it}*" }
}

tasks.withType(Test).matching { it.name.startsWith("java9") }.all {
    doFirst {
        jvmArgs = []
    }
    def java9Home = System.getenv('JAVA_9')
    executable = "${java9Home}/bin/java"
    environment['JAVA_HOME'] = java9Home
    reports.junitXml.destination = file("${project.testResultsDir}/$name")
    reports.html.destination = file("${project.reporting.baseDir}/$name")
}

if (!gradle.hasProperty("haveInstalledJava9Guard")) {
    gradle.taskGraph.whenReady { graph ->
        if (gradle.taskGraph.allTasks.any { it.name.startsWith("java9") }) {
            // Ideally, this would be a validate rule but it's not convenient to express this in the DSL yet
            if (!System.getenv(jdkVarName)) {
                throw new GradleException("A '$jdkVarName' environment variable, " +
                    "pointing to a java 9 JDK image, is required to run java9 tests!")
            }
        }
    }
    gradle.ext.haveInstalledJava9Guard = true
}
